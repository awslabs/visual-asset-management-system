   name: Build
 
   on:
     push:
       branches: [ main ]
     pull_request:
       branches: [ main ]

   jobs:
    build:
      runs-on: ubuntu-latest
      steps:
      - name: checkout repo
        uses: actions/checkout@v3

      - name: Setup Python Version
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      
      - name: Setup Ruby Version
        uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.7'

      - name: setup node for the whole package
        uses: actions/setup-node@v3
      
      - name: npm install 
        run: |
          npm install
          npm audit

      - name: Install Poetry Action
        uses: snok/install-poetry@v1
        with:
          version: 1.1.13
          virtualenvs-create: true
          virtualenvs-in-project: true
          virtualenvs-path: backend/.venv
          installer-parallel: true
     
      - name: Run yarn install
        uses: Borales/actions-yarn@v4.2.0
        with:
          dir: 'web'
          cmd: install

      - name: web build
        working-directory: web
        env:
          CI: ""
        run: |
          # npm install
          # npm audit
          npm run build
          

      - name: cdk package install
        working-directory: infra
        run: |
          npm install
          npm audit

      - name: cdk package build
        working-directory: infra
        run: |
          CDK_NAG_ENABLED=true
          export STACK_NAME=CFN_NAG_TEST
          export REGION=us-east-1
          npx cdk synth
          gem install cfn-nag
          cfn_nag_scan --input-path ./cdk.out/vams-waf-CFN_NAG_TEST-us-east-1.template.json
          cfn_nag_scan --input-path ./cdk.out/vams-CFN_NAG_TEST-us-east-1.template.json

      - name: run checks
        working-directory: backend
        run: make all
