# VAMS v2.2 to v2.3 Migration Guide

## Overview

This migration guide facilitates the upgrade from VAMS v2.2 to v2.3 by reindexing all assets and files into the new OpenSearch dual-index system. The v2.3 release introduces a Lambda-based reindexing system that simplifies the migration process.

## Migration Options

### Option 1: Automatic Reindexing via CDK Deploy (Recommended for New Deployments)

**IMPORTANT**: This option requires a two-step CDK deployment process.

For new v2.3 deployments or when upgrading from v2.2, you can enable automatic reindexing during CDK deployment:

#### Step 1: Initial CDK Deploy (Upgrade to v2.3)

First, deploy v2.3 without reindexing to create the new Lambda function and infrastructure:

```bash
cd infra
cdk deploy --all
```

This creates the reindexer Lambda function and all v2.3 infrastructure.

#### Step 2: Enable Reindexing and Deploy Again

After the initial deployment completes, enable reindexing using one of these methods:

**Method A: Configuration File**

Edit `infra/config/config.json`:
```json
{
  "app": {
    "openSearch": {
      "reindexOnCdkDeploy": true
    }
  }
}
```

Then deploy again:
```bash
cdk deploy --all
```

**Method B: CDK Context Parameter**

```bash
cdk deploy --all --context reindexOnCdkDeploy=true
```

**What Happens:**
- The reindexer Lambda function is invoked via a CloudFormation custom resource
- All assets and files are reindexed automatically
- The deployment waits for reindexing to complete
- CloudFormation reports success/failure

**Note**: After reindexing is complete, you should set `reindexOnCdkDeploy` back to `false` in your configuration to prevent reindexing on every deployment.

### Option 2: Manual Reindexing via Lambda Invocation (Recommended for Production)

For production environments or when you need more control over the reindexing process, use the Lambda invocation wrapper script.

## Architecture

### Lambda-Based Reindexing (v2.3)

The new architecture uses a deployed Lambda function for all reindexing operations:

```
reindex_utility.py (Local wrapper script)
    ↓
AWS Lambda Invoke (lambda:InvokeFunction permission only)
    ↓
Reindexer Lambda Function (deployed in AWS)
    ↓
DynamoDB AssetsMetadata Table: Insert/Update records with _asset_table_updated timestamp
    ↓
DynamoDB Streams (automatic trigger)
    ↓
Asset/File Indexer Lambda (existing infrastructure)
    ↓
OpenSearch Dual Indexes (vams-assets-v1, vams-files-v1)
```

### Key Benefits

1. **Simplified Permissions**: Only requires `lambda:InvokeFunction` permission locally
2. **Cloud Execution**: All reindexing logic runs in AWS Lambda
3. **No Local Dependencies**: No need for OpenSearch Python libraries locally
4. **Consistent Environment**: Uses deployed Lambda environment and permissions
5. **Automatic Configuration**: Lambda has all resource names via environment variables
6. **Reusability**: Same Lambda function used for migrations and manual reindexing
7. **CDK Integration**: Can be triggered automatically during deployment

## Components

### 1. Reindexer Lambda Function

Deployed as part of the v2.3 CDK stack, this Lambda function:

- **Asset Reindexing**: Updates AssetsMetadata table with `_asset_table_updated` timestamp
- **S3 File Reindexing**: Discovers S3 files and creates metadata records
- **Index Clearing**: Optional clearing of OpenSearch indexes before reindexing
- **Batch Processing**: Efficient batch operations for DynamoDB
- **File Exclusions**: Automatically excludes pipeline, preview, and temp files
- **Error Handling**: Comprehensive error tracking and reporting
- **Dual OpenSearch Support**: Works with both Serverless and Provisioned

### 2. Reindex Utility Script (`tools/reindex_utility.py`)

A simple wrapper script that invokes the Lambda function:

- Requires only `lambda:InvokeFunction` permission
- Supports synchronous and asynchronous invocation
- Displays progress and results
- No direct AWS resource access needed

### 3. Migration Script (`v2.2_to_v2.3_migration.py`)

**DEPRECATED**: This script is no longer needed. Use the Lambda invocation method instead.

The migration script has been simplified and now just invokes the Lambda function. All complex logic has been moved to the Lambda function itself.

## Prerequisites

### Required AWS Resources

1. **v2.3 CDK Stack Deployed**: The reindexer Lambda function must be deployed
2. **Lambda Function Name**: Available from CDK stack output `ReindexerFunctionNameOutput`

### Required IAM Permissions (Local Execution)

```json
{
    "Version": "2012-01-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": ["lambda:InvokeFunction"],
            "Resource": "arn:aws:lambda:*:*:function:*-reindexer-*"
        }
    ]
}
```

**That's it!** No DynamoDB, S3, or OpenSearch permissions needed locally.

### Python Dependencies

```bash
pip install boto3
```

## Usage

### Step 1: Get Lambda Function Name

After deploying v2.3, get the reindexer Lambda function name from CDK outputs:

```bash
aws cloudformation describe-stacks \
  --stack-name your-vams-stack \
  --query 'Stacks[0].Outputs[?OutputKey==`ReindexerFunctionNameOutput`].OutputValue' \
  --output text
```

Or check the CloudFormation console for the output named `ReindexerFunctionNameOutput`.

### Step 2: Configure Migration (Optional)

You can use a configuration file or command-line arguments. The configuration file is optional - command-line arguments are simpler for most use cases.

**Using Configuration File:**

1. Copy the template:
```bash
cp v2.2_to_v2.3_migration_config.json v2.2_to_v2.3_migration_prod_config.json
```

2. Edit `v2.2_to_v2.3_migration_prod_config.json`:
```json
{
    "function_name": "your-actual-reindexer-function-name",
    "operation": "both",
    "clear_indexes": false,
    "dry_run": false,
    "limit": null,
    "aws_profile": null,
    "aws_region": null,
    "log_level": "INFO"
}
```

3. Run with config file:
```bash
python v2.2_to_v2.3_migration.py --config v2.2_to_v2.3_migration_prod_config.json
```

**Note**: Command-line arguments override config file settings.

### Step 3: Run Reindexing

#### Using Command-Line Arguments (Recommended)

**Dry Run (Recommended First Step)**

Test without making changes:

```bash
python v2.2_to_v2.3_migration.py \
    --function-name your-stack-reindexer-function \
    --operation both \
    --dry-run
```

**Test with Limited Items**

Test with a small subset:

```bash
python v2.2_to_v2.3_migration.py \
    --function-name your-stack-reindexer-function \
    --operation both \
    --limit 100 \
    --dry-run
```

**Production Reindexing**

Reindex all assets and files:

```bash
python v2.2_to_v2.3_migration.py \
    --function-name your-stack-reindexer-function \
    --operation both
```

**Clear Indexes Before Reindexing**

Remove all existing documents before reindexing:

```bash
python v2.2_to_v2.3_migration.py \
    --function-name your-stack-reindexer-function \
    --operation both \
    --clear-indexes
```

**With AWS Profile and Region**

```bash
python v2.2_to_v2.3_migration.py \
    --function-name your-stack-reindexer-function \
    --operation both \
    --profile my-profile \
    --region us-west-2
```

#### Using Configuration File

**With config file:**
```bash
python v2.2_to_v2.3_migration.py --config v2.2_to_v2.3_migration_prod_config.json
```

**Override config file with command-line:**
```bash
python v2.2_to_v2.3_migration.py \
    --config v2.2_to_v2.3_migration_prod_config.json \
    --clear-indexes \
    --dry-run
```

#### Using Reindex Utility Directly

You can also use the reindex utility script directly (same functionality):

```bash
cd ../../tools

# Basic reindexing
python reindex_utility.py \
    --function-name your-stack-reindexer-function \
    --operation both

# With all options
python reindex_utility.py \
    --function-name your-stack-reindexer-function \
    --operation both \
    --clear-indexes \
    --dry-run \
    --limit 100 \
    --async
```

### Command Line Options

```
--function-name    : Lambda function name (required, from CDK output)
--operation        : assets, files, or both (default: both)
--dry-run          : Test without making changes
--limit            : Maximum number of items to process (for testing)
--clear-indexes    : Clear OpenSearch indexes before reindexing
--async            : Use asynchronous invocation (for large datasets)
--profile          : AWS profile name
--region           : AWS region
--log-level        : DEBUG, INFO, WARNING, ERROR (default: INFO)
```

## Migration Process

### Phase 1: Asset Reindexing

1. Lambda scans DynamoDB asset storage table
2. For each asset, fetches existing metadata record (if exists)
3. Preserves all existing metadata attributes
4. Updates/inserts record in AssetsMetadata table with `_asset_table_updated` timestamp
5. DynamoDB Stream automatically triggers asset indexer Lambda
6. Assets are reindexed in OpenSearch asset index

### Phase 2: S3 File Reindexing

1. Lambda scans S3 buckets table for bucket/prefix configurations
2. Recursively lists all objects in each bucket
3. Excludes system files (pipeline, preview, temp-upload folders and .previewFile. patterns)
4. For each file with asset metadata:
   - Fetches existing metadata record (if exists)
   - Preserves all existing metadata attributes
   - Formats assetId as `/{assetId}/{relative/path}`
   - Updates/inserts record in AssetsMetadata table
5. DynamoDB Stream triggers file indexer Lambda
6. Files are indexed in OpenSearch file index

### Phase 3: Results

The Lambda function returns detailed results including:
- Success/failure counts for assets and files
- Processing statistics (buckets processed, objects scanned)
- Error details if any failures occurred
- Index clearing results (if --clear-indexes was used)

## Monitoring

### Real-Time Progress

The utility script displays progress in real-time:

```
2024-01-15 10:00:00 - INFO - VAMS OPENSEARCH REINDEXER - LAMBDA INVOCATION
2024-01-15 10:00:00 - INFO - Function: vams-prod-reindexer
2024-01-15 10:00:00 - INFO - Operation: both
2024-01-15 10:00:00 - INFO - Invoking Lambda function...
2024-01-15 10:05:00 - INFO - LAMBDA INVOCATION SUCCESSFUL
2024-01-15 10:05:00 - INFO - Execution Time: 300.45 seconds
2024-01-15 10:05:00 - INFO - Asset Reindexing Results:
2024-01-15 10:05:00 - INFO -   Total: 5000
2024-01-15 10:05:00 - INFO -   Success: 5000
2024-01-15 10:05:00 - INFO -   Failed: 0
2024-01-15 10:05:00 - INFO - File Reindexing Results:
2024-01-15 10:05:00 - INFO -   Buckets Processed: 3
2024-01-15 10:05:00 - INFO -   Objects Scanned: 50500
2024-01-15 10:05:00 - INFO -   Total: 50000
2024-01-15 10:05:00 - INFO -   Success: 50000
2024-01-15 10:05:00 - INFO -   Failed: 0
```

### CloudWatch Logs

Monitor Lambda function logs:

```bash
# Reindexer Lambda logs
aws logs tail /aws/lambda/your-reindexer-function --follow

# Asset/File indexer logs
aws logs tail /aws/lambda/your-indexer-function --follow

# Filter for errors
aws logs filter-log-events \
  --log-group-name /aws/lambda/your-reindexer-function \
  --filter-pattern "ERROR"
```

## Troubleshooting

### Lambda Function Not Found

**Symptom**: "Lambda function 'xxx' not found"

**Solution**: Verify the function name from CDK outputs:
```bash
aws cloudformation describe-stacks \
  --stack-name your-vams-stack \
  --query 'Stacks[0].Outputs[?OutputKey==`ReindexerFunctionNameOutput`].OutputValue' \
  --output text
```

### Permission Errors

**Symptom**: "Access denied" or "User is not authorized"

**Solution**: Ensure your IAM user/role has `lambda:InvokeFunction` permission for the reindexer Lambda function.

### Lambda Timeout

**Symptom**: Lambda times out for large datasets

**Solution**: Use asynchronous invocation:
```bash
python tools/reindex_utility.py \
    --function-name your-function \
    --operation both \
    --async
```

### Verification Failures

**Symptom**: Document counts don't match expected values

**Solutions**:
1. Wait longer for DynamoDB Streams processing to complete
2. Check CloudWatch logs for indexer errors
3. Verify DynamoDB Streams are enabled on AssetsMetadata table
4. Re-run reindexing with `--clear-indexes` flag

## Performance Considerations

### Small Datasets (< 10,000 items)

Use synchronous invocation (default):
```bash
python tools/reindex_utility.py --function-name xxx --operation both
```

### Medium Datasets (10,000 - 100,000 items)

Use synchronous invocation with monitoring:
```bash
python tools/reindex_utility.py --function-name xxx --operation both
# Monitor CloudWatch Logs in parallel
```

### Large Datasets (> 100,000 items)

Use asynchronous invocation:
```bash
python tools/reindex_utility.py --function-name xxx --operation both --async
# Monitor via CloudWatch Logs
```

## Rollback

If migration fails or issues are discovered:

1. **Clear and Re-run**: Use `--clear-indexes` flag to clear indexes and reindex
2. **Partial Reindex**: Use `--operation assets` or `--operation files` to reindex specific types
3. **Idempotent**: The reindexing can be safely re-run multiple times

**To Clear and Re-run:**
```bash
python tools/reindex_utility.py \
    --function-name your-function \
    --operation both \
    --clear-indexes
```

## Comparison: Old vs New Approach

### Old Approach (v2.2 Migration Script)
- Required extensive local permissions (DynamoDB, S3, OpenSearch)
- Needed OpenSearch Python libraries installed locally
- Required SSM parameter configuration
- Complex local execution environment
- Separate verification script needed

### New Approach (v2.3 Lambda-Based)
- Requires only `lambda:InvokeFunction` permission locally
- No OpenSearch libraries needed locally
- All configuration in Lambda environment variables
- Simple wrapper script
- No separate verification script needed
- Can be triggered via CDK deploy

## Support

For issues or questions:

1. Check CloudWatch logs for Lambda function errors
2. Run with `--log-level DEBUG` for verbose output
3. Test with `--dry-run` and `--limit` flags first
4. Verify Lambda function exists and is accessible

## Migration Checklist

- [ ] Deploy v2.3 CDK stack (first deployment)
- [ ] Get Lambda function name from CDK outputs
- [ ] Test with dry-run: `--dry-run --limit 100`
- [ ] Run production reindexing: `--operation both`
- [ ] Monitor CloudWatch logs for completion
- [ ] Verify search functionality in VAMS UI
- [ ] (Optional) Set `reindexOnCdkDeploy: false` if you used CDK deploy method

## MCP Servers Used

This implementation utilized the following MCP servers:

- awslabs.cdk-mcp-server (CDK best practices and patterns)
- awslabs.aws-documentation-mcp-server (AWS service documentation)
