# VAMS v2.2 to v2.3 Migration Guide

## Overview

This migration script facilitates the upgrade from VAMS v2.2 to v2.3 by reindexing all assets and files into the new OpenSearch dual-index system. The migration leverages a reusable utility script that updates DynamoDB records and publishes S3 notification events to trigger automatic reindexing.

## Architecture

### New Approach (v2.3)

The migration has been completely refactored to use a modular, reusable architecture:

```
v2.2_to_v2.3_migration.py (Simplified orchestration script)
    ↓
reindex_utility.py (Reusable reindexing utility)
    ↓
    ├─→ DynamoDB: Update _os_reindex_date timestamps
    └─→ SNS: Publish S3 ObjectCreated events
            ↓
            └─→ File Indexer Lambda (existing infrastructure)
```

### Key Benefits

1. **Reusability**: The `reindex_utility.py` can be used for future migrations or manual reindexing
2. **Simplicity**: Migration script reduced from ~800 to ~400 lines
3. **Maintainability**: Clear separation of concerns
4. **Efficiency**: Leverages existing S3 event processing infrastructure
5. **Reliability**: Uses proven AWS event notification patterns

## Components

### 1. Reindex Utility (`tools/reindex_utility.py`)

A standalone Python module that provides:

-   **Asset Reindexing**: Updates `_os_reindex_date` field in DynamoDB asset table
-   **S3 File Reindexing**: Generates and publishes S3 ObjectCreated events to SNS
-   **Batch Processing**: Efficient batch operations for DynamoDB and SNS
-   **Error Handling**: Comprehensive error tracking and reporting
-   **Dry-Run Mode**: Test without making changes

### 2. Migration Script (`v2.2_to_v2.3_migration.py`)

Orchestrates the migration process:

1. Loads configuration from JSON file or command line
2. Initializes the reindex utility
3. Reindexes assets (FIRST - updates DynamoDB timestamps)
4. Reindexes S3 files (SECOND - publishes SNS events)
5. Waits for async indexing to complete
6. Verifies migration success
7. Generates detailed reports

### 3. Configuration File (`v2.2_to_v2.3_migration_config.json`)

Centralized configuration with comprehensive documentation including:

-   DynamoDB table names
-   SNS topic ARN
-   SSM parameters for OpenSearch
-   Reindex settings (batch sizes, workers, delays)
-   Migration settings (dry-run, verification wait time)

## Prerequisites

### Required AWS Resources

1. **DynamoDB Tables**:

    - Asset storage table (contains asset records)
    - S3 asset buckets table (contains bucket/prefix configurations)

2. **SNS Topic**:

    - S3 object created notification topic
    - Must be the same topic that file indexer Lambda subscribes to

3. **Lambda Functions**:

    - Asset indexer Lambda (triggered by DynamoDB Stream)
    - File indexer Lambda (triggered by SNS)

4. **OpenSearch**:
    - Dual-index system deployed (asset and file indexes)
    - SSM parameters configured with index names and endpoint

### Required IAM Permissions

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": ["dynamodb:Scan", "dynamodb:UpdateItem", "dynamodb:BatchWriteItem"],
            "Resource": "arn:aws:dynamodb:*:*:table/YOUR_ASSET_TABLE"
        },
        {
            "Effect": "Allow",
            "Action": ["dynamodb:Scan"],
            "Resource": "arn:aws:dynamodb:*:*:table/YOUR_S3_BUCKETS_TABLE"
        },
        {
            "Effect": "Allow",
            "Action": ["s3:ListBucket", "s3:GetObject", "s3:HeadObject"],
            "Resource": ["arn:aws:s3:::your-asset-bucket", "arn:aws:s3:::your-asset-bucket/*"]
        },
        {
            "Effect": "Allow",
            "Action": ["sns:Publish"],
            "Resource": "arn:aws:sns:*:*:YOUR_SNS_TOPIC"
        },
        {
            "Effect": "Allow",
            "Action": ["ssm:GetParameter"],
            "Resource": "arn:aws:ssm:*:*:parameter/vams/*"
        },
        {
            "Effect": "Allow",
            "Action": ["es:ESHttpGet"],
            "Resource": "arn:aws:es:*:*:domain/YOUR_OPENSEARCH_DOMAIN/*"
        }
    ]
}
```

### Python Dependencies

```bash
pip install boto3 opensearchpy aws-requests-auth
```

## Configuration

### Step 1: Copy Configuration Template

```bash
cp v2.2_to_v2.3_migration_config.json v2.2_to_v2.3_migration_prod_config.json
```

### Step 2: Update Configuration

Edit `v2.2_to_v2.3_migration_prod_config.json` and replace placeholder values:

```json
{
    "asset_storage_table_name": "vams-prod-AssetStorageTable-ABC123",
    "s3_asset_buckets_table_name": "vams-prod-S3AssetBucketsTable-XYZ789",
    "s3_object_created_sns_topic_arn": "arn:aws:sns:us-east-1:123456789012:vams-prod-s3ObjectCreated",
    "opensearch_asset_index_ssm_param": "/vams-prod/aos/assetIndexName",
    "opensearch_file_index_ssm_param": "/vams-prod/aos/fileIndexName",
    "opensearch_endpoint_ssm_param": "/vams-prod/aos/endPoint",
    "aws_profile": "vams-prod",
    "aws_region": "us-east-1",
    "reindex_settings": {
        "asset_batch_size": 25,
        "s3_batch_size": 100,
        "max_workers": 10,
        "sns_publish_delay": 0.05
    },
    "log_level": "INFO",
    "dry_run": false,
    "verification_wait_time": 300
}
```

### Finding Resource Names

#### DynamoDB Tables

```bash
aws dynamodb list-tables --profile your-profile | grep -i asset
aws dynamodb list-tables --profile your-profile | grep -i s3
```

#### SNS Topic ARN

```bash
aws sns list-topics --profile your-profile | grep -i s3object
```

Or check the file indexer Lambda function's event source mapping:

```bash
aws lambda list-event-source-mappings --function-name your-file-indexer-function
```

#### SSM Parameters

```bash
aws ssm get-parameters-by-path --path /vams --profile your-profile
```

## Usage

### Dry Run (Recommended First Step)

Always perform a dry run first to validate configuration:

```bash
python v2.2_to_v2.3_migration.py \
    --config v2.2_to_v2.3_migration_prod_config.json \
    --dry-run
```

### Test with Limited Items

Test with a small subset before full migration:

```bash
python v2.2_to_v2.3_migration.py \
    --config v2.2_to_v2.3_migration_prod_config.json \
    --limit 100 \
    --dry-run
```

### Production Migration

Once validated, run the full migration:

```bash
python v2.2_to_v2.3_migration.py \
    --config v2.2_to_v2.3_migration_prod_config.json
```

### Command Line Overrides

Override configuration values via command line:

```bash
python v2.2_to_v2.3_migration.py \
    --profile my-profile \
    --region us-west-2 \
    --asset-storage-table MyAssetTable \
    --s3-asset-buckets-table MyS3BucketsTable \
    --sns-topic-arn arn:aws:sns:us-west-2:123456789012:my-topic \
    --dry-run
```

### Skip Verification

Skip the verification step (useful for very large datasets):

```bash
python v2.2_to_v2.3_migration.py \
    --config v2.2_to_v2.3_migration_prod_config.json \
    --skip-verification
```

## Migration Process

### Phase 1: Asset Reindexing

1. Scans DynamoDB asset storage table
2. Updates `_os_reindex_date` field with current timestamp
3. DynamoDB Stream triggers asset indexer Lambda
4. Asset indexer reindexes assets in OpenSearch asset index

**Why First?** Assets must exist in the asset index before files can reference them.

### Phase 2: S3 File Reindexing

1. Scans S3 buckets table for bucket/prefix configurations
2. Lists all objects in each bucket/prefix
3. Constructs S3 ObjectCreated notification events
4. Publishes events to SNS topic
5. File indexer Lambda processes events
6. Files are indexed in OpenSearch file index with asset tag inheritance

**Why Second?** Files need to look up parent asset tags during indexing.

### Phase 3: Verification

1. Waits for async indexing operations to complete
2. Queries OpenSearch indexes for document counts
3. Compares actual vs expected counts
4. Generates detailed migration report

## Monitoring

### Real-Time Progress

The script provides detailed progress logging:

```
2024-01-15 10:00:00 - INFO - ASSET REINDEXING
2024-01-15 10:00:01 - INFO - Scanning asset table: vams-AssetStorageTable
2024-01-15 10:00:05 - INFO - Found 5000 assets to reindex
2024-01-15 10:00:06 - INFO - Processing asset batch 1/200 (25 assets)
2024-01-15 10:00:07 - INFO - Processing asset batch 2/200 (25 assets)
...
2024-01-15 10:05:00 - INFO - ASSET REINDEXING COMPLETE
2024-01-15 10:05:00 - INFO -   Total: 5000
2024-01-15 10:05:00 - INFO -   Success: 5000
2024-01-15 10:05:00 - INFO -   Failed: 0
```

### CloudWatch Logs

Monitor Lambda function logs for indexing progress:

```bash
# Asset indexer logs
aws logs tail /aws/lambda/your-asset-indexer-function --follow

# File indexer logs
aws logs tail /aws/lambda/your-file-indexer-function --follow
```

### Migration Reports

Reports are saved to `reports/migration_report_YYYYMMDD_HHMMSS.json`:

```json
{
    "migration_info": {
        "version": "v2.2_to_v2.3",
        "started_at": "2024-01-15T10:00:00.000Z",
        "completed_at": "2024-01-15T10:30:00.000Z",
        "duration_seconds": 1800,
        "dry_run": false
    },
    "asset_reindexing": {
        "success_count": 5000,
        "failed_count": 0,
        "total_count": 5000
    },
    "file_reindexing": {
        "success_count": 50000,
        "failed_count": 0,
        "total_count": 50000,
        "buckets_processed": 3,
        "objects_scanned": 50500
    },
    "verification": {
        "asset_index": {
            "expected_documents": 5000,
            "actual_documents": 5000,
            "success_rate": 100.0
        },
        "file_index": {
            "expected_documents": 50000,
            "actual_documents": 49950,
            "success_rate": 99.9
        },
        "overall_success": true
    }
}
```

## Troubleshooting

### Rate Limiting

**Symptom**: SNS publish errors or throttling

**Solution**:

```json
{
    "reindex_settings": {
        "sns_publish_delay": 0.1, // Increase from 0.05
        "max_workers": 5 // Decrease from 10
    }
}
```

### Verification Failures

**Symptom**: Document counts don't match expected values

**Solutions**:

1. Increase verification wait time:

    ```json
    {
        "verification_wait_time": 600 // 10 minutes instead of 5
    }
    ```

2. Check CloudWatch logs for indexer errors:

    ```bash
    aws logs filter-log-events \
      --log-group-name /aws/lambda/your-file-indexer \
      --filter-pattern "ERROR"
    ```

3. Verify SNS topic ARN matches file indexer subscription:
    ```bash
    aws sns list-subscriptions-by-topic \
      --topic-arn your-sns-topic-arn
    ```

### Permission Errors

**Symptom**: Access denied errors

**Solution**: Verify IAM permissions (see Prerequisites section)

### Configuration Errors

**Symptom**: "Please set the X in the CONFIG" error

**Solution**: Ensure all required configuration values are set (not starting with "YOUR\_")

### Memory Issues

**Symptom**: Script crashes with memory errors on large datasets

**Solution**:

1. Process in batches using `--limit`:

    ```bash
    python v2.2_to_v2.3_migration.py --config config.json --limit 10000
    ```

2. Run multiple times with different filters (requires code modification)

## Performance Tuning

### For Small Datasets (< 10,000 items)

```json
{
    "reindex_settings": {
        "asset_batch_size": 25,
        "s3_batch_size": 100,
        "max_workers": 10,
        "sns_publish_delay": 0.05
    },
    "verification_wait_time": 180
}
```

### For Medium Datasets (10,000 - 100,000 items)

```json
{
    "reindex_settings": {
        "asset_batch_size": 25,
        "s3_batch_size": 100,
        "max_workers": 15,
        "sns_publish_delay": 0.05
    },
    "verification_wait_time": 300
}
```

### For Large Datasets (> 100,000 items)

```json
{
    "reindex_settings": {
        "asset_batch_size": 25,
        "s3_batch_size": 200,
        "max_workers": 20,
        "sns_publish_delay": 0.03
    },
    "verification_wait_time": 600
}
```

## Rollback

If migration fails or issues are discovered:

1. **Assets**: The `_os_reindex_date` field can be removed or set to null
2. **Files**: No rollback needed - file indexing is idempotent
3. **OpenSearch**: Indexes can be deleted and recreated if needed

## Using the Reindex Utility Standalone

The reindex utility can be used independently for manual reindexing:

```python
from tools.reindex_utility import ReindexUtility
import boto3

session = boto3.Session(profile_name='my-profile')

utility = ReindexUtility(
    session=session,
    asset_table_name='vams-AssetStorageTable',
    s3_buckets_table_name='vams-S3AssetBucketsTable',
    sns_topic_arn='arn:aws:sns:us-east-1:123456789012:vams-s3ObjectCreated'
)

# Reindex only assets
asset_results = utility.reindex_assets(dry_run=False)

# Reindex only files
file_results = utility.reindex_s3_files(dry_run=False)
```

Or via command line:

```bash
# Reindex assets only
python tools/reindex_utility.py \
    --profile my-profile \
    --asset-table vams-AssetStorageTable \
    --operation assets

# Reindex files only
python tools/reindex_utility.py \
    --profile my-profile \
    --s3-buckets-table vams-S3AssetBucketsTable \
    --sns-topic arn:aws:sns:us-east-1:123456789012:vams-s3ObjectCreated \
    --operation files

# Reindex both
python tools/reindex_utility.py \
    --profile my-profile \
    --asset-table vams-AssetStorageTable \
    --s3-buckets-table vams-S3AssetBucketsTable \
    --sns-topic arn:aws:sns:us-east-1:123456789012:vams-s3ObjectCreated \
    --operation both
```

## Support

For issues or questions:

1. Check CloudWatch logs for Lambda function errors
2. Review migration report JSON for detailed error information
3. Run with `--log-level DEBUG` for verbose output
4. Test with `--dry-run` and `--limit` flags first

## MCP Servers Used

This implementation utilized the following MCP servers:

-   None (standard implementation without MCP server dependencies)
