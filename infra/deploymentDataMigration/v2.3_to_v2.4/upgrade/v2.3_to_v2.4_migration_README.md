# VAMS v2.3 to v2.4 Migration Guide

## Overview

This migration guide facilitates the complete upgrade from VAMS v2.3 to v2.4, including:

1. **Phase 1-4: Constraints Migration** - Migrates constraints from `AuthEntitiesTable` to optimized `ConstraintsStorageTable`
2. **Phase 5: Metadata Migration** - Migrates metadata from old single-record format to new individual-field format
3. **Phase 5.5: Metadata Schema Migration** - Migrates metadata schemas from field-per-record to schema-per-database format
4. **Phase 6: OpenSearch Reindexing** - Updates OpenSearch indexes for assets and files

The v2.4 release introduces significant performance improvements and architectural changes across authorization, metadata management, and search functionality.

## What's New in v2.4

### Constraints Table (Phase 1-4)

**Performance Improvements:**

-   **20-100x faster constraint queries** using GSI instead of table scans
-   **30-60x faster authorization** with fixed cache expiration (30 seconds vs 15-30 minutes)
-   **Logarithmic query complexity** O(log n) instead of O(n)
-   **20-100x reduction in DynamoDB read capacity** usage

**Architecture Changes:**

-   **Dedicated Constraints Table**: Constraints moved from `AuthEntitiesTable` to `ConstraintsStorageTable`
-   **Optimized Schema**: Simple primary key (`constraintId`) instead of composite key
-   **JSON String Storage**: Complex fields stored as JSON strings for efficiency
-   **GSI Support**: Three GSIs for efficient querying (GroupPermissionsIndex, UserPermissionsIndex, ObjectTypeIndex)

### Metadata Table (Phase 5)

**Architecture Changes:**

-   **Individual Field Records**: Each metadata field becomes a separate DynamoDB record
-   **Composite Key**: `databaseId:assetId:filePath` for efficient querying
-   **Unified Table**: Single table for both asset and file metadata
-   **Type Safety**: All metadata values stored with explicit type information

### Metadata Schema Table (Phase 5.5)

**Architecture Changes:**

-   **Schema-per-Database**: One schema record per database (instead of field-per-record)
-   **Aggregated Fields**: All fields for a database combined into single schema
-   **Enhanced Field Types**: Support for new types (multiline_string, lla, etc.)
-   **Controlled Lists**: Proper handling of inline controlled list values
-   **Schema Naming**: All migrated schemas named "migratedSchema"

**Old Format (v2.3):**

```json
[
    {
        "databaseId": "archiveDoop",
        "field": "awdawd",
        "dataType": "controlled-list",
        "required": false,
        "sequenceNumber": 3
    },
    {
        "databaseId": "archiveDoop",
        "field": "dsrfgdfg",
        "dataType": "inline-controlled-list",
        "inlineControlledListValues": "awd",
        "required": true,
        "sequenceNumber": 1
    }
]
```

**New Format (v2.4):**

```json
{
    "metadataSchemaId": "uuid-123",
    "databaseId": "archiveDoop",
    "metadataSchemaEntityType": "assetMetadata",
    "schemaName": "migratedSchema",
    "enabled": true,
    "fields": {
        "fields": [
            {
                "metadataFieldKeyName": "dsrfgdfg",
                "metadataFieldValueType": "inline_controlled_list",
                "required": true,
                "sequence": 1,
                "controlledListKeys": ["awd"]
            }
        ]
    }
}
```

**Field Type Mappings:**

-   `string` ‚Üí `string`
-   `textarea` ‚Üí `multiline_string`
-   `number` ‚Üí `number`
-   `boolean` ‚Üí `boolean`
-   `date` ‚Üí `date`
-   `inline-controlled-list` ‚Üí `inline_controlled_list`
-   `location` ‚Üí `lla` (with default lat/long/alt values)
-   `controlled-list` ‚Üí **SKIPPED** (no values provided)

**Old Format (v2.3):**

```json
{
    "databaseId": "db123",
    "assetId": "asset456",
    "field1": "value1",
    "field2": "value2",
    "field3": "value3"
}
```

**New Format (v2.4):**

```json
[
    {
        "metadataKey": "field1",
        "databaseId:assetId:filePath": "db123:asset456:/",
        "metadataValue": "value1",
        "metadataValueType": "string"
    },
    {
        "metadataKey": "field2",
        "databaseId:assetId:filePath": "db123:asset456:/",
        "metadataValue": "value2",
        "metadataValueType": "string"
    }
]
```

### OpenSearch Reindexing (Phase 6)

**Purpose:**

-   Updates OpenSearch indexes with new metadata structure
-   Ensures search functionality works with v2.4 metadata format
-   Reindexes both assets and files

## Prerequisites

### Required AWS Resources

1. **v2.4 CDK Stack Deployed**: All new tables and Lambda functions must exist
2. **Table Names**: Available from CloudFormation stack outputs
3. **Reindexer Lambda**: Deployed as part of v2.4 stack

### Required IAM Permissions

```json
{
    "Version": "2012-01-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": ["dynamodb:Query", "dynamodb:Scan", "dynamodb:GetItem"],
            "Resource": [
                "arn:aws:dynamodb:*:*:table/*AuthEntitiesTable*",
                "arn:aws:dynamodb:*:*:table/*OLD-MetadataTable*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "dynamodb:PutItem",
                "dynamodb:BatchWriteItem",
                "dynamodb:GetItem",
                "dynamodb:Scan"
            ],
            "Resource": [
                "arn:aws:dynamodb:*:*:table/*ConstraintsStorageTable*",
                "arn:aws:dynamodb:*:*:table/*AssetFileMetadataStorageTable*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": ["dynamodb:DeleteItem", "dynamodb:BatchWriteItem"],
            "Resource": [
                "arn:aws:dynamodb:*:*:table/*AuthEntitiesTable*",
                "arn:aws:dynamodb:*:*:table/*OLD-MetadataTable*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": ["lambda:InvokeFunction"],
            "Resource": "arn:aws:lambda:*:*:function/*ReindexerFunction*"
        }
    ]
}
```

### Python Dependencies

```bash
pip install boto3
```

## Usage

### Step 1: Get Resource Names

Get table and function names from CloudFormation stack outputs:

```bash
aws cloudformation describe-stacks \
  --stack-name your-vams-stack \
  --query 'Stacks[0].Outputs[?contains(OutputKey, `Table`) || contains(OutputKey, `Function`)].{Key:OutputKey,Value:OutputValue}' \
  --output table
```

Look for:

-   `AuthEntitiesTableOutput` ‚Üí Source for constraints (Phase 1-4)
-   `ConstraintsStorageTableOutput` ‚Üí Target for constraints (Phase 1-4)
-   `OLD-MetadataTableOutput` ‚Üí Source for metadata (Phase 5)
-   `AssetFileMetadataStorageTableOutput` ‚Üí Target for metadata (Phase 5)
-   `OLD-MetadataSchemaTableOutput` ‚Üí Source for metadata schemas (Phase 5.5)
-   `MetadataSchemaStorageTableV2Output` ‚Üí Target for metadata schemas (Phase 5.5)
-   `ReindexerFunctionNameOutput` ‚Üí Lambda for reindexing (Phase 6)

### Step 2: Configure Migration

Edit `v2.3_to_v2.4_migration_config.json`:

```json
{
    "auth_entities_table_name": "YOUR-AuthEntitiesTable-NAME",
    "constraints_table_name": "YOUR-ConstraintsStorageTable-NAME",
    "old_metadata_table_name": "YOUR-OLD-MetadataTable-NAME",
    "new_metadata_table_name": "YOUR-AssetFileMetadataStorageTable-NAME",
    "old_metadata_schema_table_name": "YOUR-OLD-MetadataSchemaTable-NAME",
    "new_metadata_schema_table_name": "YOUR-MetadataSchemaStorageTableV2-NAME",
    "reindexer_function_name": "YOUR-ReindexerFunction-NAME",
    "clear_indexes_before_reindex": false,
    "delete_old_data": false,
    "dry_run": false,
    "limit": null,
    "aws_profile": null,
    "aws_region": "us-east-1",
    "log_level": "INFO"
}
```

### Step 3: Run Migration

#### Dry Run (Recommended First Step)

Test all phases without making changes:

```bash
python v2.3_to_v2.4_migration.py \
    --config v2.3_to_v2.4_migration_config.json \
    --dry-run
```

#### Test with Limited Items

Test with a small subset:

```bash
python v2.3_to_v2.4_migration.py \
    --config v2.3_to_v2.4_migration_config.json \
    --limit 10 \
    --dry-run
```

#### Production Migration

Run complete migration (keeps old data for safety):

```bash
python v2.3_to_v2.4_migration.py \
    --config v2.3_to_v2.4_migration_config.json
```

#### Verify Migration

After migration:

1. Test user authorization with different roles
2. Check metadata display in VAMS UI
3. Test search functionality
4. Verify constraint management works
5. Monitor CloudWatch logs

#### Optional Cleanup

Delete old data after thorough verification (recommended after 1 week):

```bash
python v2.3_to_v2.4_migration.py \
    --config v2.3_to_v2.4_migration_config.json \
    --delete-old-data
```

### Command Line Options

```
--config              : Path to configuration JSON file (required)
--delete-old-data     : Delete old data from source tables after migration
--dry-run             : Test without making changes
--limit               : Maximum number of items to migrate per table (for testing)
--profile             : AWS profile name
--region              : AWS region
--log-level           : DEBUG, INFO, WARNING, ERROR (default: INFO)
```

## Migration Process Details

### Phase 1-4: Constraints Migration

**Process:**

1. Scan `AuthEntitiesTable` for constraints
2. Transform to denormalized format with GSI support
3. Write to `ConstraintsStorageTable`
4. Optional: Delete from old table
5. Verify migration success

**Example Output:**

```
================================================================================
PHASE 1-4: CONSTRAINTS TABLE MIGRATION
================================================================================

üìñ PHASE 1: Scanning old table for constraints...
Found 25 constraints in old table

üîÑ PHASE 2: Transforming 25 constraints to denormalized format...
Transformation complete: 25 constraints ‚Üí 75 denormalized items, 0 errors

üíæ PHASE 3: Writing constraints to new table...
Write complete: 25 success, 0 failures, 0 skipped

‚è≠Ô∏è PHASE 4: Skipping deletion (--delete-old-data not specified)

‚úÖ Constraints verification PASSED
```

### Phase 5: Metadata Migration

**Process:**

1. Scan old metadata table for all records
2. Parse `assetId` to determine asset vs file:
    - Starts with `/` ‚Üí File (e.g., `/asset123/file.jpg`)
    - No `/` ‚Üí Asset (e.g., `asset123`)
3. Transform each field to individual record
4. Write to new metadata table
5. Optional: Delete from old table
6. Verify migration success

**Asset ID Parsing:**

-   **Asset**: `"x08fb7689-34d5-4329-8eb1-81dcccca3459"` ‚Üí `filePath = "/"`
-   **File**: `"/x08fb7689-34d5-4329-8eb1-81dcccca3459/Brou_Lux.jpg"` ‚Üí `filePath = "Brou_Lux.jpg"`

**Field Exclusions:**

-   `databaseId` (used as key)
-   `assetId` (used as key)
-   Fields starting with `_` (internal fields)

**Example Output:**

```
================================================================================
PHASE 5: METADATA TABLE MIGRATION
================================================================================

üìñ Scanning old metadata table...
Found 150 metadata records in old table

üîÑ Transforming 150 metadata records to new format...
Transformation complete: 150 records ‚Üí 450 metadata items, 0 errors

üíæ Writing metadata to new table...
Write complete: 450 success, 0 failures, 0 skipped

‚è≠Ô∏è Skipping deletion (--delete-old-data not specified)

‚úÖ Metadata verification PASSED
```

### Phase 5.5: Metadata Schema Migration

**Process:**

1. Scan old metadata schema table for all field records
2. Group fields by `databaseId`
3. For each database:
    - Delete existing "migratedSchema" (if exists)
    - Transform fields to new format
    - Create single schema record with all fields
4. Write schemas to new table
5. Optional: Delete from old table
6. Verify migration success

**Field Transformations:**

-   **Type Mapping**: `textarea` ‚Üí `multiline_string`, `location` ‚Üí `lla`
-   **Controlled Lists**: Parse comma-delimited values to arrays
-   **Dependencies**: Convert DynamoDB list to string array
-   **Location Fields**: Create LLA default value from lat/long/zoom
-   **Skip Invalid**: Skip `controlled-list` fields without values

**Example Output:**

```
PHASE 5.5: METADATA SCHEMA TABLE MIGRATION

üìñ Scanning old metadata schema table...
Found 45 field records in old schema table

üîÑ Grouping 45 field records by database...
Grouped fields into 3 databases

Processing database: archiveDoop (15 fields)
Deleted 1 existing 'migratedSchema' for database archiveDoop
Skipped 2 fields for database archiveDoop (controlled-list without values)

Processing database: testDB (20 fields)
Deleted 0 existing 'migratedSchema' for database testDB

Processing database: prodDB (10 fields)
Deleted 1 existing 'migratedSchema' for database prodDB

Transformation complete: 3 databases ‚Üí 3 schemas, 0 errors
Deleted 2 existing 'migratedSchema' records

üíæ Writing metadata schemas to new table...
Batch 1/1: Wrote 3 schemas
Write complete: 3 success, 0 failures, 0 skipped

‚è≠Ô∏è Skipping deletion (--delete-old-data not specified)

‚úÖ Metadata schema verification PASSED
```

**Schema Structure:**
Each migrated schema contains:

-   `metadataSchemaId`: Unique UUID
-   `databaseId`: Original database ID
-   `metadataSchemaEntityType`: "assetMetadata"
-   `schemaName`: "migratedSchema"
-   `enabled`: true
-   `fields`: JSON array of all field definitions

**Location Field Example:**

```json
{
    "metadataFieldKeyName": "locationField",
    "metadataFieldValueType": "lla",
    "required": false,
    "sequence": 1,
    "defaultMetadataFieldValue": "{\"lat\": 1.23e+08, \"long\": 123123, \"alt\": 123123}"
}
```

### Phase 6: OpenSearch Reindexing

**Process:**

1. Invoke reindexer Lambda function
2. Reindex both assets and files
3. Optional: Clear indexes before reindexing
4. Monitor progress and report results

**Example Output:**

```
================================================================================
PHASE 6: OPENSEARCH REINDEXING
================================================================================

üîç Invoking reindexer Lambda function...
================================================================================
VAMS OPENSEARCH REINDEXER - LAMBDA INVOCATION
================================================================================
Function: vams-ReindexerFunction
Operation: both
Dry Run: False
Limit: None
Clear Indexes: False
================================================================================

Asset Reindexing Results:
  Total: 150
  Success: 150
  Failed: 0

File Reindexing Results:
  Buckets Processed: 3
  Objects Scanned: 450
  Total: 450
  Success: 450
  Failed: 0

‚úÖ Reindexing completed successfully
```

VAMS v2.3 to v2.4 COMPLETE MIGRATION
Phase 1-4: Constraints Migration
Source: vams-AuthEntitiesTable
Target: vams-ConstraintsStorageTable
Phase 5: Metadata Migration
Source: vams-OLD-MetadataTable
Target: vams-AssetFileMetadataStorageTable
Phase 6: OpenSearch Reindex
Function: vams-ReindexerFunction
Clear Indexes: False
Delete Old Data: False
Dry Run: False

[Phase 1-4 output...]
[Phase 5 output...]
[Phase 6 output...]

COMPLETE MIGRATION SUMMARY
Migration Duration: 45.3 seconds

Phase 1-4: Constraints Migration
Write Success: 25
Write Failures: 0
Write Skipped: 0

Phase 5: Metadata Migration
Write Success: 450
Write Failures: 0
Write Skipped: 0

Phase 6: OpenSearch Reindex
Status: Completed

Dry Run: False
Status: ‚úÖ SUCCESS

```
## Complete Migration Output Example

```

VAMS v2.3 to v2.4 COMPLETE MIGRATION
Phase 1-4: Constraints Migration
Source: vams-AuthEntitiesTable
Target: vams-ConstraintsStorageTable
Phase 5: Metadata Migration
Source: vams-OLD-MetadataTable
Target: vams-AssetFileMetadataStorageTable
Phase 5.5: Metadata Schema Migration
Source: vams-OLD-MetadataSchemaTable
Target: vams-MetadataSchemaStorageTableV2
Phase 6: OpenSearch Reindex
Function: vams-ReindexerFunction
Clear Indexes: False
Delete Old Data: False
Dry Run: False

[Phase 1-4 output...]
[Phase 5 output...]
[Phase 5.5 output...]
[Phase 6 output...]

COMPLETE MIGRATION SUMMARY
Migration Duration: 52.7 seconds

Phase 1-4: Constraints Migration
Write Success: 25
Write Failures: 0
Write Skipped: 0

Phase 5: Metadata Migration
Write Success: 450
Write Failures: 0
Write Skipped: 0

Phase 5.5: Metadata Schema Migration
Write Success: 3
Write Failures: 0
Write Skipped: 0

Phase 6: OpenSearch Reindex
Status: Completed

Dry Run: False
Status: ‚úÖ SUCCESS

```
================================================================================
VAMS v2.3 to v2.4 COMPLETE MIGRATION
================================================================================
Phase 1-4: Constraints Migration
  Source: vams-AuthEntitiesTable
  Target: vams-ConstraintsStorageTable
Phase 5: Metadata Migration
  Source: vams-OLD-MetadataTable
  Target: vams-AssetFileMetadataStorageTable
Phase 6: OpenSearch Reindex
  Function: vams-ReindexerFunction
  Clear Indexes: False
Delete Old Data: False
Dry Run: False
================================================================================

[Phase 1-4 output...]
[Phase 5 output...]
[Phase 6 output...]

================================================================================
COMPLETE MIGRATION SUMMARY
================================================================================
Migration Duration: 45.3 seconds

Phase 1-4: Constraints Migration
  Write Success: 25
  Write Failures: 0
  Write Skipped: 0

Phase 5: Metadata Migration
  Write Success: 450
  Write Failures: 0
  Write Skipped: 0

Phase 6: OpenSearch Reindex
  Status: Completed

Dry Run: False
Status: ‚úÖ SUCCESS
================================================================================
```

## Troubleshooting

### Common Issues

#### Table Not Found

**Symptom**: "Table 'xxx' not found"

**Solution**: Verify all table names from CloudFormation outputs

#### Permission Errors

**Symptom**: "Access denied" or "User is not authorized"

**Solution**: Ensure IAM permissions include all required tables and Lambda invoke

#### Metadata Transformation Errors

**Symptom**: "Error transforming metadata record X"

**Solutions**:

1. Check old metadata table structure
2. Run with `--log-level DEBUG`
3. Use `--limit 1` to test single record
4. Verify `databaseId` and `assetId` fields exist

#### Metadata Schema Transformation Errors

**Symptom**: "Error processing database X" or "Skipping field with type 'controlled-list'"

**Solutions**:

1. Check old metadata schema table structure
2. Verify field records have required columns (databaseId, field, dataType)
3. Run with `--log-level DEBUG` to see skipped fields
4. Note: `controlled-list` fields without values are intentionally skipped
5. Location fields require latitudeField, longitudeField, zoomLevelField

#### Reindex Failures

**Symptom**: "Reindexing failed"

**Solutions**:

1. Check Lambda function exists and is accessible
2. Verify Lambda has permissions to access DynamoDB and OpenSearch
3. Check CloudWatch logs for Lambda execution errors
4. Can manually invoke reindexer Lambda after migration

### Rollback Procedures

#### Option 1: Re-run Migration

Migration is idempotent - safe to re-run:

```bash
python v2.3_to_v2.4_migration.py --config v2.3_to_v2.4_migration_config.json
```

#### Option 2: Manual Reindex

If only reindex failed:

```bash
# Use the reindex utility directly
python ../../tools/reindex_utility.py \
    --function-name vams-ReindexerFunction \
    --operation both
```

#### Option 3: Restore from Old Tables

If old data wasn't deleted (recommended):

1. Old data remains in source tables
2. Can manually copy back if needed
3. Or re-deploy v2.3 CDK stack

## Performance Considerations

### Small Deployments (< 100 items per table)

-   Migration completes in under 1 minute
-   No special considerations needed

### Medium Deployments (100-1000 items per table)

-   Migration completes in 1-5 minutes
-   Monitor progress in real-time
-   Consider using `--limit` for initial testing

### Large Deployments (> 1000 items per table)

-   May take 5-15 minutes
-   Test with `--limit 100` first
-   Monitor DynamoDB write capacity
-   Consider running during low-traffic period

## Migration Checklist

-   [ ] Deploy v2.4 CDK stack
-   [ ] Get all resource names from CloudFormation outputs (including schema tables)
-   [ ] Update configuration file with actual names
-   [ ] Run dry-run: `--dry-run --limit 10`
-   [ ] Run production migration (without deletion)
-   [ ] Verify all phases completed successfully (1-4, 5, 5.5, 6)
-   [ ] Test authorization works correctly
-   [ ] Test metadata display in UI
-   [ ] Test metadata schema management in UI
-   [ ] Test search functionality
-   [ ] Monitor CloudWatch logs for 24-48 hours
-   [ ] (Optional) Run migration with `--delete-old-data` after verification

## Schema Comparisons

### Constraints Schema

**Old (v2.3):**

```
Primary Key: entityType (PK), sk (SK)
Query: Table scan O(n)
```

**New (v2.4):**

```
Primary Key: constraintId (PK)
GSIs: GroupPermissionsIndex, UserPermissionsIndex, ObjectTypeIndex
Query: GSI lookup O(log n)
```

### Metadata Schema

**Old (v2.3):**

```
Single record per asset/file with all fields as columns
{
  "databaseId": "db123",
  "assetId": "asset456",
  "field1": "value1",
  "field2": "value2"
}
```

**New (v2.4):**

```
Individual record per metadata field
{
  "metadataKey": "field1",
  "databaseId:assetId:filePath": "db123:asset456:/",
  "metadataValue": "value1",
  "metadataValueType": "string"
}
```

## Support

For issues or questions:

1. Check migration logs
2. Run with `--log-level DEBUG`
3. Test with `--dry-run` and `--limit` flags
4. Verify all resource names are correct
5. Check IAM permissions for all resources
6. Review CloudWatch logs for Lambda and DynamoDB

## MCP Servers Used

This implementation utilized the following MCP servers:

-   awslabs.aws-iac-mcp-server (CDK and DynamoDB best practices)
-   awslabs.aws-documentation-mcp-server (AWS service documentation)
-   awslabs.core-mcp-server (Architecture and design guidance)
